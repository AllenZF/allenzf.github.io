<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.42.4 (0)
 -->
<!-- Title: context_switch_riscv Pages: 1 -->
<svg width="613pt" height="843pt"
 viewBox="0.00 0.00 612.66 843.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 839)">
<title>context_switch_riscv</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-839 608.66,-839 608.66,4 -4,4"/>
<!-- prepare -->
<g id="node1" class="node">
<title>prepare</title>
<path fill="none" stroke="black" d="M286.16,-835C286.16,-835 178.16,-835 178.16,-835 172.16,-835 166.16,-829 166.16,-823 166.16,-823 166.16,-811 166.16,-811 166.16,-805 172.16,-799 178.16,-799 178.16,-799 286.16,-799 286.16,-799 292.16,-799 298.16,-805 298.16,-811 298.16,-811 298.16,-823 298.16,-823 298.16,-829 292.16,-835 286.16,-835"/>
<text text-anchor="middle" x="232.16" y="-814.2" font-family="Times,serif" font-size="11.00">prepare_task_switch</text>
</g>
<!-- arch_hook -->
<g id="node2" class="node">
<title>arch_hook</title>
<path fill="none" stroke="black" d="M301.16,-762C301.16,-762 163.16,-762 163.16,-762 157.16,-762 151.16,-756 151.16,-750 151.16,-750 151.16,-738 151.16,-738 151.16,-732 157.16,-726 163.16,-726 163.16,-726 301.16,-726 301.16,-726 307.16,-726 313.16,-732 313.16,-738 313.16,-738 313.16,-750 313.16,-750 313.16,-756 307.16,-762 301.16,-762"/>
<text text-anchor="middle" x="232.16" y="-741.2" font-family="Times,serif" font-size="11.00">arch_start_context_switch</text>
</g>
<!-- prepare&#45;&gt;arch_hook -->
<g id="edge1" class="edge">
<title>prepare&#45;&gt;arch_hook</title>
<path fill="none" stroke="black" d="M232.16,-798.81C232.16,-790.79 232.16,-781.05 232.16,-772.07"/>
<polygon fill="black" stroke="black" points="235.66,-772.03 232.16,-762.03 228.66,-772.03 235.66,-772.03"/>
</g>
<!-- mm_branch -->
<g id="node3" class="node">
<title>mm_branch</title>
<path fill="none" stroke="black" d="M220.2,-688.07C220.2,-688.07 11.8,-671.93 11.8,-671.93 5.82,-671.46 5.82,-670.54 11.8,-670.07 11.8,-670.07 220.2,-653.93 220.2,-653.93 226.18,-653.46 238.15,-653.46 244.13,-653.93 244.13,-653.93 452.53,-670.07 452.53,-670.07 458.51,-670.54 458.51,-671.46 452.53,-671.93 452.53,-671.93 244.13,-688.07 244.13,-688.07 238.15,-688.54 226.18,-688.54 220.2,-688.07"/>
<text text-anchor="middle" x="232.16" y="-668.2" font-family="Times,serif" font-size="11.00">MM decision: next&#45;&gt;mm ? to_user : to_kernel</text>
</g>
<!-- arch_hook&#45;&gt;mm_branch -->
<g id="edge2" class="edge">
<title>arch_hook&#45;&gt;mm_branch</title>
<path fill="none" stroke="black" d="M232.16,-725.81C232.16,-717.79 232.16,-708.05 232.16,-699.07"/>
<polygon fill="black" stroke="black" points="235.66,-699.03 232.16,-689.03 228.66,-699.03 235.66,-699.03"/>
</g>
<!-- to_kernel -->
<g id="node4" class="node">
<title>to_kernel</title>
<path fill="none" stroke="black" d="M185.66,-528C185.66,-528 94.66,-528 94.66,-528 88.66,-528 82.66,-522 82.66,-516 82.66,-516 82.66,-504 82.66,-504 82.66,-498 88.66,-492 94.66,-492 94.66,-492 185.66,-492 185.66,-492 191.66,-492 197.66,-498 197.66,-504 197.66,-504 197.66,-516 197.66,-516 197.66,-522 191.66,-528 185.66,-528"/>
<text text-anchor="middle" x="140.16" y="-513.2" font-family="Times,serif" font-size="11.00">to kernel:</text>
<text text-anchor="middle" x="140.16" y="-501.2" font-family="Times,serif" font-size="11.00">enter_lazy_tlb(...)</text>
</g>
<!-- mm_branch&#45;&gt;to_kernel -->
<g id="edge3" class="edge">
<title>mm_branch&#45;&gt;to_kernel</title>
<path fill="none" stroke="black" d="M174.19,-657.42C162.86,-652.3 152.3,-645.11 145.16,-635 125.21,-606.71 128.34,-565.09 133.43,-538.01"/>
<polygon fill="black" stroke="black" points="136.89,-538.57 135.51,-528.06 130.04,-537.13 136.89,-538.57"/>
<text text-anchor="middle" x="220.66" y="-623.8" font-family="Times,serif" font-size="14.00">next&#45;&gt;mm == NULL</text>
</g>
<!-- to_user -->
<g id="node5" class="node">
<title>to_user</title>
<path fill="none" stroke="black" d="M406.66,-602C406.66,-602 239.66,-602 239.66,-602 233.66,-602 227.66,-596 227.66,-590 227.66,-590 227.66,-558 227.66,-558 227.66,-552 233.66,-546 239.66,-546 239.66,-546 406.66,-546 406.66,-546 412.66,-546 418.66,-552 418.66,-558 418.66,-558 418.66,-590 418.66,-590 418.66,-596 412.66,-602 406.66,-602"/>
<text text-anchor="middle" x="323.16" y="-589.2" font-family="Times,serif" font-size="11.00">to user:</text>
<text text-anchor="middle" x="323.16" y="-577.2" font-family="Times,serif" font-size="11.00">membarrier_arch_switch_mm()</text>
<text text-anchor="middle" x="323.16" y="-565.2" font-family="Times,serif" font-size="11.00">switch_mm() &#45;&gt; set_mm()</text>
<text text-anchor="middle" x="323.16" y="-553.2" font-family="Times,serif" font-size="11.00">(ASID alloc / SATP write)</text>
</g>
<!-- mm_branch&#45;&gt;to_user -->
<g id="edge4" class="edge">
<title>mm_branch&#45;&gt;to_user</title>
<path fill="none" stroke="black" d="M271.15,-655.98C281.66,-650.71 292.28,-643.8 300.16,-635 306.1,-628.37 310.58,-620.05 313.92,-611.73"/>
<polygon fill="black" stroke="black" points="317.3,-612.66 317.34,-602.07 310.7,-610.32 317.3,-612.66"/>
<text text-anchor="middle" x="381.66" y="-623.8" font-family="Times,serif" font-size="14.00">next&#45;&gt;mm != NULL</text>
</g>
<!-- switch_cid -->
<g id="node9" class="node">
<title>switch_cid</title>
<path fill="none" stroke="black" d="M167.66,-255C167.66,-255 90.66,-255 90.66,-255 84.66,-255 78.66,-249 78.66,-243 78.66,-243 78.66,-231 78.66,-231 78.66,-225 84.66,-219 90.66,-219 90.66,-219 167.66,-219 167.66,-219 173.66,-219 179.66,-225 179.66,-231 179.66,-231 179.66,-243 179.66,-243 179.66,-249 173.66,-255 167.66,-255"/>
<text text-anchor="middle" x="129.16" y="-234.2" font-family="Times,serif" font-size="11.00">switch_mm_cid</text>
</g>
<!-- to_kernel&#45;&gt;switch_cid -->
<g id="edge9" class="edge">
<title>to_kernel&#45;&gt;switch_cid</title>
<path fill="none" stroke="black" d="M136.74,-491.68C133.52,-473.81 129.16,-445.07 129.16,-420 129.16,-420 129.16,-420 129.16,-309 129.16,-294.65 129.16,-278.67 129.16,-265.51"/>
<polygon fill="black" stroke="black" points="132.66,-265.22 129.16,-255.22 125.66,-265.22 132.66,-265.22"/>
</g>
<!-- asid_alloc -->
<g id="node6" class="node">
<title>asid_alloc</title>
<path fill="none" stroke="black" d="M410.66,-474C410.66,-474 237.66,-474 237.66,-474 231.66,-474 225.66,-468 225.66,-462 225.66,-462 225.66,-450 225.66,-450 225.66,-444 231.66,-438 237.66,-438 237.66,-438 410.66,-438 410.66,-438 416.66,-438 422.66,-444 422.66,-450 422.66,-450 422.66,-462 422.66,-462 422.66,-468 416.66,-474 410.66,-474"/>
<text text-anchor="middle" x="324.16" y="-459.2" font-family="Times,serif" font-size="11.00">ASID allocator: __new_context()</text>
<text text-anchor="middle" x="324.16" y="-447.2" font-family="Times,serif" font-size="11.00">update mm&#45;&gt;context.id</text>
</g>
<!-- to_user&#45;&gt;asid_alloc -->
<g id="edge5" class="edge">
<title>to_user&#45;&gt;asid_alloc</title>
<path fill="none" stroke="black" d="M323.4,-545.8C323.56,-527.33 323.77,-502.98 323.93,-484.46"/>
<polygon fill="black" stroke="black" points="327.43,-484.34 324.02,-474.31 320.43,-484.28 327.43,-484.34"/>
</g>
<!-- satp_write -->
<g id="node7" class="node">
<title>satp_write</title>
<path fill="none" stroke="black" d="M480.66,-401C480.66,-401 169.66,-401 169.66,-401 163.66,-401 157.66,-395 157.66,-389 157.66,-389 157.66,-377 157.66,-377 157.66,-371 163.66,-365 169.66,-365 169.66,-365 480.66,-365 480.66,-365 486.66,-365 492.66,-371 492.66,-377 492.66,-377 492.66,-389 492.66,-389 492.66,-395 486.66,-401 480.66,-401"/>
<text text-anchor="middle" x="325.16" y="-380.2" font-family="Times,serif" font-size="11.00">csr_write(CSR_SATP, pfn | (asid&lt;&lt;ASID_SHIFT) | mode)</text>
</g>
<!-- asid_alloc&#45;&gt;satp_write -->
<g id="edge6" class="edge">
<title>asid_alloc&#45;&gt;satp_write</title>
<path fill="none" stroke="black" d="M324.41,-437.81C324.52,-429.79 324.66,-420.05 324.78,-411.07"/>
<polygon fill="black" stroke="black" points="328.28,-411.08 324.92,-401.03 321.28,-410.98 328.28,-411.08"/>
</g>
<!-- tlb_icache -->
<g id="node8" class="node">
<title>tlb_icache</title>
<path fill="none" stroke="black" d="M459.66,-328C459.66,-328 190.66,-328 190.66,-328 184.66,-328 178.66,-322 178.66,-316 178.66,-316 178.66,-304 178.66,-304 178.66,-298 184.66,-292 190.66,-292 190.66,-292 459.66,-292 459.66,-292 465.66,-292 471.66,-298 471.66,-304 471.66,-304 471.66,-316 471.66,-316 471.66,-322 465.66,-328 459.66,-328"/>
<text text-anchor="middle" x="325.16" y="-313.2" font-family="Times,serif" font-size="11.00">local_flush_tlb_all / local_flush_tlb_all_asid</text>
<text text-anchor="middle" x="325.16" y="-301.2" font-family="Times,serif" font-size="11.00">and deferred icache flush (flush_icache_deferred)</text>
</g>
<!-- satp_write&#45;&gt;tlb_icache -->
<g id="edge7" class="edge">
<title>satp_write&#45;&gt;tlb_icache</title>
<path fill="none" stroke="black" d="M325.16,-364.81C325.16,-356.79 325.16,-347.05 325.16,-338.07"/>
<polygon fill="black" stroke="black" points="328.66,-338.03 325.16,-328.03 321.66,-338.03 328.66,-338.03"/>
</g>
<!-- tlb_icache&#45;&gt;switch_cid -->
<g id="edge8" class="edge">
<title>tlb_icache&#45;&gt;switch_cid</title>
<path fill="none" stroke="black" d="M278.22,-291.99C250.54,-281.97 215.33,-269.21 186.08,-258.62"/>
<polygon fill="black" stroke="black" points="187,-255.23 176.41,-255.11 184.62,-261.81 187,-255.23"/>
</g>
<!-- note -->
<g id="node13" class="node">
<title>note</title>
<polygon fill="none" stroke="black" points="598.66,-255 197.66,-255 197.66,-219 604.66,-219 604.66,-249 598.66,-255"/>
<polyline fill="none" stroke="black" points="598.66,-255 598.66,-249 "/>
<polyline fill="none" stroke="black" points="604.66,-249 598.66,-249 "/>
<text text-anchor="middle" x="401.16" y="-240.2" font-family="Times,serif" font-size="11.00">ASID rollover &#45;&gt; __flush_context() &#45;&gt; mark CPUs for TLB invalidation</text>
<text text-anchor="middle" x="401.16" y="-228.2" font-family="Times,serif" font-size="11.00">I&#45;cache: no HW shootdown; uses IPIs or deferred local flush</text>
</g>
<!-- tlb_icache&#45;&gt;note -->
<g id="edge13" class="edge">
<title>tlb_icache&#45;&gt;note</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M343.56,-291.81C355.51,-280.65 371.02,-266.16 382.94,-255.03"/>
</g>
<!-- prepare_lock -->
<g id="node10" class="node">
<title>prepare_lock</title>
<path fill="none" stroke="black" d="M182.66,-182C182.66,-182 75.66,-182 75.66,-182 69.66,-182 63.66,-176 63.66,-170 63.66,-170 63.66,-158 63.66,-158 63.66,-152 69.66,-146 75.66,-146 75.66,-146 182.66,-146 182.66,-146 188.66,-146 194.66,-152 194.66,-158 194.66,-158 194.66,-170 194.66,-170 194.66,-176 188.66,-182 182.66,-182"/>
<text text-anchor="middle" x="129.16" y="-161.2" font-family="Times,serif" font-size="11.00">prepare_lock_switch</text>
</g>
<!-- switch_cid&#45;&gt;prepare_lock -->
<g id="edge10" class="edge">
<title>switch_cid&#45;&gt;prepare_lock</title>
<path fill="none" stroke="black" d="M129.16,-218.81C129.16,-210.79 129.16,-201.05 129.16,-192.07"/>
<polygon fill="black" stroke="black" points="132.66,-192.03 129.16,-182.03 125.66,-192.03 132.66,-192.03"/>
</g>
<!-- switch_to_node -->
<g id="node11" class="node">
<title>switch_to_node</title>
<path fill="none" stroke="black" d="M222.16,-109C222.16,-109 36.16,-109 36.16,-109 30.16,-109 24.16,-103 24.16,-97 24.16,-97 24.16,-85 24.16,-85 24.16,-79 30.16,-73 36.16,-73 36.16,-73 222.16,-73 222.16,-73 228.16,-73 234.16,-79 234.16,-85 234.16,-85 234.16,-97 234.16,-97 234.16,-103 228.16,-109 222.16,-109"/>
<text text-anchor="middle" x="129.16" y="-94.2" font-family="Times,serif" font-size="11.00">switch_to &#45;&gt; __switch_to</text>
<text text-anchor="middle" x="129.16" y="-82.2" font-family="Times,serif" font-size="11.00">(FPU/vector/envcfg/icache checks)</text>
</g>
<!-- prepare_lock&#45;&gt;switch_to_node -->
<g id="edge11" class="edge">
<title>prepare_lock&#45;&gt;switch_to_node</title>
<path fill="none" stroke="black" d="M129.16,-145.81C129.16,-137.79 129.16,-128.05 129.16,-119.07"/>
<polygon fill="black" stroke="black" points="132.66,-119.03 129.16,-109.03 125.66,-119.03 132.66,-119.03"/>
</g>
<!-- finish -->
<g id="node12" class="node">
<title>finish</title>
<path fill="none" stroke="black" d="M176.66,-36C176.66,-36 81.66,-36 81.66,-36 75.66,-36 69.66,-30 69.66,-24 69.66,-24 69.66,-12 69.66,-12 69.66,-6 75.66,0 81.66,0 81.66,0 176.66,0 176.66,0 182.66,0 188.66,-6 188.66,-12 188.66,-12 188.66,-24 188.66,-24 188.66,-30 182.66,-36 176.66,-36"/>
<text text-anchor="middle" x="129.16" y="-15.2" font-family="Times,serif" font-size="11.00">finish_task_switch</text>
</g>
<!-- switch_to_node&#45;&gt;finish -->
<g id="edge12" class="edge">
<title>switch_to_node&#45;&gt;finish</title>
<path fill="none" stroke="black" d="M129.16,-72.81C129.16,-64.79 129.16,-55.05 129.16,-46.07"/>
<polygon fill="black" stroke="black" points="132.66,-46.03 129.16,-36.03 125.66,-46.03 132.66,-46.03"/>
</g>
</g>
</svg>
